title UC 28 - Créer une prise en charge

Acteurs: Administrateur
Lifelines:
  Administrateur
  Interface Administration (UI Admin)
  Système de Gestion Prises en Charge (Backend/Système)
  Base de Données (DB)
  Service d'Audit (Audit Service)
  Service de Paiement (Interne/Externe - Optionnel)
  Service de Notification (Optionnel)

Flux:
  Administrateur -> UI Admin: Accéder section gestion prises en charge
  Administrateur -> UI Admin: Cliquer "Créer nouvelle prise en charge"
  UI Admin --> Administrateur: Afficher formulaire de saisie prise en charge

  Administrateur -> UI Admin: Rechercher/Sélectionner mutualiste principal [ID Mutualiste]
  UI Admin -> Système de Gestion Prises en Charge: Demander infos mutualiste/ayants droit [ID Mutualiste]
  Système de Gestion Prises en Charge -> DB: Récupérer infos [ID Mutualiste]
  DB --> Système de Gestion Prises en Charge: Retourner infos
  Système de Gestion Prises en Charge --> UI Admin: Envoyer infos mutualiste/ayants droit
  UI Admin --> Administrateur: Afficher infos mutualiste/ayants droit et catégories de prise en charge

  Administrateur -> UI Admin: Sélectionner mutualiste/ayant droit (si applicable)
  Administrateur -> UI Admin: Choisir catégorie de prise en charge
  Administrateur -> UI Admin: Saisir détails (Date dépense, Montant total, Montant pris en charge, Description, Références)
  Administrateur -> UI Admin: Définir Statut (Enregistrée, Validée, Refusée...)
  Administrateur -> UI Admin: Cliquer "Enregistrer"

  UI Admin -> Système de Gestion Prises en Charge: Envoyer données prise en charge [ID Mutualiste/Ayant Droit, Données Prise en Charge]

  Système de Gestion Prises en Charge -> Système de Gestion Prises en Charge: Valider données et règles métier (Alt A2, A3)

  Alt [Validation réussie]
    Système de Gestion Prises en Charge -> DB: Créer nouvel enregistrement prise en charge [Données, IDs]
    DB --> Système de Gestion Prises en Charge: Confirmation création
    Système de Gestion Prises en Charge -> Service d'Audit: Enregistrer action création/validation (Qui, Quand, Pour Qui, Quoi)
    Service d'Audit --> Système de Gestion Prises en Charge: Confirmation audit

    Opt [Statut déclenche paiement]
      Système de Gestion Prises en Charge -> Service de Paiement: Initier/Planifier paiement [ID Prise en Charge, Montant]
      Service de Paiement --> Système de Gestion Prises en Charge: Statut initiation paiement (Exc E3)

    Opt [Notification configurée]
      Système de Gestion Prises en Charge -> Service de Notification: Envoyer notification au mutualiste [ID Mutualiste, Infos Statut Prise en Charge]
      Service de Notification --> Système de Gestion Prises en Charge: Statut envoi notification (Exc E3)

    Système de Gestion Prises en Charge --> UI Admin: Indiquer Succès Enregistrement
    UI Admin --> Administrateur: Afficher message succès

  Alt [Validation KO (Alt A2, A3)]
    Système de Gestion Prises en Charge --> UI Admin: Indiquer Échec Validation avec erreurs/motifs
    UI Admin --> Administrateur: Afficher messages d'erreur

  Alt [Enregistrement avec statut "Refusée" (Alt A4)]
     Système de Gestion Prises en Charge -> DB: Créer enregistrement prise en charge [Données avec Statut Refusée]
     DB --> Système de Gestion Prises en Charge: Confirmation création Refusée
     Système de Gestion Prises en Charge -> Service d'Audit: Enregistrer action refus (Qui, Quand, Pour Qui, Motif si applicable)
     Service d'Audit --> Système de Gestion Prises en Charge: Confirmation audit
     Opt [Notification refus configurée]
       Système de Gestion Prises en Charge -> Service de Notification: Envoyer notification refus au mutualiste
     Système de Gestion Prises en Charge --> UI Admin: Indiquer Succès Enregistrement Refus
     UI Admin --> Administrateur: Afficher message succès

  Alt [Erreur Système lors enregistrement (Exc E2)]
    Système de Gestion Prises en Charge -> Système de Gestion Prises en Charge: Enregistrer log d'erreur technique
    Système de Gestion Prises en Charge --> UI Admin: Indiquer Échec Technique
    UI Admin --> Administrateur: Afficher message d'erreur générique

  Alt [Mutualiste/Ayant Droit introuvable (Exc E1)]
    DB --> Système de Gestion Prises en Charge: Indiquer introuvable
    Système de Gestion Prises en Charge --> UI Admin: Indiquer erreur (introuvable)
    UI Admin --> Administrateur: Afficher message d'erreur

  Alt [Annulation par l'Administrateur (Alt A1)]
    Administrateur --> UI Admin: Cliquer "Annuler"
    UI Admin --> Administrateur: Rediriger (pas d'action backend)

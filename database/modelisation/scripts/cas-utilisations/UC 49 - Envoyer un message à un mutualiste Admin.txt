title UC 49 - Envoyer un message à un mutualiste (Admin)

Acteurs: Administrateur
Lifelines:
  Administrateur
  Interface Administration (UI Admin)
  Système Messagerie Interne (Backend/Système)
  Base de Données (DB)
  Système de Gestion Documents (Optionnel - pour pièces jointes)
  Service d'Audit (Audit Service)
  Service de Notification Mutualiste (Email/Interne)

Flux:
  Administrateur -> UI Admin: Se connecter à interface administration
  Administrateur -> UI Admin: Naviguer vers section "Messagerie Interne" (UC 48 implicite)
  Administrateur -> UI Admin: Cliquer "Nouveau Message" / "Envoyer message à un mutualiste"

  UI Admin --> Administrateur: Afficher formulaire de composition message

  Administrateur -> UI Admin: Rechercher et sélectionner mutualiste destinataire [ID Mutualiste]
  UI Admin -> Système Messagerie Interne: Vérifier mutualiste existe et peut recevoir messages (Alt A2) [ID Mutualiste]
  Système Messagerie Interne -> DB: Récupérer infos mutualiste [ID Mutualiste]
  DB --> Système Messagerie Interne: Retourner infos
  Alt [Mutualiste trouvé et éligible (Alt A2 si non)]
    Système Messagerie Interne --> UI Admin: Confirmer mutualiste valide
    UI Admin --> Administrateur: Afficher confirmation destinataire

    Administrateur -> UI Admin: Saisir Objet et Corps du message, (Optionnel) Joindre documents
    Administrateur -> UI Admin: Cliquer "Envoyer"

    UI Admin -> Système Messagerie Interne: Envoyer message et pièces jointes [ID Administrateur Expéditeur, ID Mutualiste Destinataire, Sujet, Corps, Fichiers]

    Système Messagerie Interne -> Système Messagerie Interne: Valider message (Alt A3) et pièces jointes (Alt A4)

    Alt [Validation réussie]
      Système Messagerie Interne -> DB: Créer nouvel enregistrement message [Données Message], Potentiellement créer nouvelle conversation si nécessaire
      DB --> Système Messagerie Interne: Confirmation création message/conversation
      Sistema Messagerie Interne -> Service d'Audit: Enregistrer action envoi message (Qui, Quand, À Qui, Sujet)
      Service d'Audit --> Système Messagerie Interne: Confirmation audit

      Opt [Documents joints]
        Système Messagerie Interne -> Système de Gestion Documents: Traiter et associer documents au message
        Système de Gestion Documents --> Système Messagerie Interne: Statut traitement documents (Alt A4 si échec)

      Système Messagerie Interne --> UI Admin: Indiquer Succès Envoi Message
      UI Admin --> Administrateur: Afficher message confirmation succès

      Sistema Messagerie Interne -> Service de Notification Mutualiste: Notifier Mutualiste destinataire de nouveau message (UC 50 implicite)
      Service de Notification Mutualiste --> Sistema Messagerie Interne: Statut notification (Exc E2)

    Alt [Validation KO (Alt A3) ou Échec Pièce Jointe (Alt A4 qui bloque l'envoi)]
      Système Messagerie Interne --> UI Admin: Indiquer Échec Envoi avec erreurs/motifs
      UI Admin --> Administrateur: Afficher messages d'erreur sur formulaire

    Alt [Erreur Système lors enregistrement/acheminement (Exc E1)]
      Sistema Messagerie Interne -> Sistema Messagerie Interne: Enregistrer log d'erreur technique
      Sistema Messagerie Interne --> UI Admin: Indiquer Échec Technique
      UI Admin --> Administrateur: Afficher message générique

  Alt [Mutualiste introuvable ou inéligible (Alt A2, Exc E1)]
    DB --> Système Messagerie Interne: Indiquer introuvable ou inéligible
    Sistema Messagerie Interne --> UI Admin: Indiquer erreur (mutualiste introuvable/inéligible)
    UI Admin --> Administrateur: Afficher message d'erreur

  Alt [Annulation par l'Administrateur (Alt A1)]
    Administrateur --> UI Admin: Cliquer "Annuler" / Quitter
    UI Admin --> Administrateur: Abandonner formulaire
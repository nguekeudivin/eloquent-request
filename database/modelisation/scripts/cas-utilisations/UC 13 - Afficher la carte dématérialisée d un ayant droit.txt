title UC 13 - Afficher la carte dématérialisée d un ayant droit

Acteurs: Mutualiste
Lifelines:
  Mutualiste
  Interface Utilisateur (UI)
  Système de Gestion Carte (Backend/Système)
  Base de Données (DB)
  Système de Gestion Ayants Droit (Implicite pour liste)

Flux:
  Mutualiste -> UI: Se connecter à son espace personnel (UC 1)
  Mutualiste -> UI: Naviguer vers section Ayants Droit / Cartes Ayants Droit

  UI -> Système de Gestion Ayants Droit: Demander liste ayants droit du mutualiste [ID Mutualiste] (UC 11 implicite)
  Système de Gestion Ayants Droit -> DB: Récupérer ayants droit [ID Mutualiste]
  DB --> Système de Gestion Ayants Droit: Retourner liste ayants droit (ou vide)
  Système de Gestion Ayants Droit --> UI: Envoyer liste ayants droit
  UI --> Mutualiste: Afficher liste des ayants droit

  Opt [Aucun ayant droit (Alt A1)]
    UI --> Mutualiste: Message "Pas d'ayants droit" (Fin du flux ici)

  Else [Liste d'ayants droit non vide]
    Mutualiste -> UI: Sélectionner un ayant droit [ID Ayant Droit]
    UI -> Système de Gestion Carte: Demander affichage carte ayant droit [ID Ayant Droit, ID Mutualiste Principal]

    Système de Gestion Carte -> DB: Vérifier lien Ayant Droit -> Mutualiste Principal et statuts (Ayant Droit, Principal) [ID Ayant Droit, ID Mutualiste Principal]
    DB --> Système de Gestion Carte: Retourner résultats vérification et éligibilité

    Alt [Vérifications OK et ayant droit éligible]
      Système de Gestion Carte -> DB: Récupérer infos carte ayant droit (Nom Ayant Droit, Lien Adhérent Principal, Code QR/Barres, etc.) [ID Ayant Droit]
      DB --> Système de Gestion Carte: Retourner infos carte
      Système de Gestion Carte -> Système de Gestion Carte: Potentiellement générer image/représentation carte
      Système de Gestion Carte --> UI: Envoyer données/image de la carte ayant droit
      UI --> Mutualiste: Afficher la carte dématérialisée de l'ayant droit

    Alt [Ayant droit introuvable/non rattaché (Alt A2)]
      Système de Gestion Carte --> UI: Indiquer erreur (Ayant droit introuvable/non rattaché)
      UI --> Mutualiste: Afficher message d'erreur

    Alt [Non éligible à la carte (Alt A3)]
      Système de Gestion Carte --> UI: Indiquer non-éligibilité
      UI --> Mutualiste: Afficher message ("Adhésion principale non active", "Ayant droit non validé", etc.)

    Alt [Carte non générée (Alt A4)]
      Système de Gestion Carte --> UI: Indiquer carte ayant droit non générée
      UI --> Mutualiste: Afficher message ("Carte ayant droit en cours de préparation", etc.)

    Alt [Erreur Système lors affichage (Exc E1)]
      Système de Gestion Carte -> Système de Gestion Carte: Enregistrer log d'erreur technique
      Système de Gestion Carte --> UI: Indiquer Échec Technique
      UI --> Mutualiste: Afficher message d'erreur générique
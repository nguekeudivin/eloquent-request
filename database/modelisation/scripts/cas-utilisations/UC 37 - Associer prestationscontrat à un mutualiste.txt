title UC 37 - Associer prestations/contrat à un mutualiste

Acteurs: Administrateur
Lifelines:
  Administrateur
  Interface Administration (UI Admin)
  Système de Gestion Contrats Adhérents (Backend/Système)
  Base de Données (DB)
  Système de Configuration (Backend/Système - pour liste contrats)
  Service d'Audit (Audit Service)
  Service de Calcul Cotisations (Backend/Système - Optionnel)
  Service de Notification (Optionnel)

Flux:
  Administrateur -> UI Admin: Accéder section gestion adhérents / contrats adhérents
  Administrateur -> UI Admin: Rechercher/Sélectionner mutualiste [ID Mutualiste]

  UI Admin -> Système de Gestion Contrats Adhérents: Demander dossier mutualiste et contrats associés [ID Mutualiste]
  Système de Gestion Contrats Adhérents -> DB: Récupérer infos mutualiste et contrats historiques [ID Mutualiste]
  DB --> Système de Gestion Contrats Adhérents: Retourner infos

  Alt [Mutualiste trouvé (Exc E1 si introuvable)]
    Système de Gestion Contrats Adhérents -> Système de Configuration: Demander liste modèles contrats actifs
    Système de Configuration -> DB: Récupérer modèles contrats actifs (UC 36 config)
    DB --> Système de Configuration: Retourner liste modèles
    Système de Configuration --> Système de Gestion Contrats Adhérents: Envoyer liste modèles
    Système de Gestion Contrats Adhérents --> UI Admin: Envoyer infos mutualiste, contrats historiques, et liste modèles disponibles
    UI Admin --> Administrateur: Afficher dossier mutualiste avec options gestion contrat et liste modèles

    Administrateur -> UI Admin: Sélectionner un modèle de contrat à associer [ID Modèle Contrat]
    Administrateur -> UI Admin: Spécifier date de début de validité (si applicable)
    Administrateur -> UI Admin: Cliquer "Enregistrer" / "Associer le contrat"

    UI Admin -> Système de Gestion Contrats Adhérents: Envoyer requête association contrat [ID Mutualiste, ID Modèle Contrat, Date Début]

    Système de Gestion Contrats Adhérents -> DB: Vérifier Modèle Contrat existe/actif (Alt A2) et Statut mutualiste [ID Modèle Contrat, ID Mutualiste]
    Système de Gestion Contrats Adhérents -> Système de Configuration: Vérifier éligibilité mutualiste au contrat (selon règles config UC 36) [ID Mutualiste, ID Modèle Contrat]

    Alt [Modèle valide, éligibilité OK, et pas de conflit contrat (Alt A2, A3, A4)]
      DB --> Système de Gestion Contrats Adhérents: Résultat vérifications
      Système de Configuration --> Système de Gestion Contrats Adhérents: Résultat vérif éligibilité
      Système de Gestion Contrats Adhérents -> DB: Enregistrer association Mutualiste-Contrat (avec date début) [ID Mutualiste, ID Modèle Contrat, Date Début]
      DB --> Système de Gestion Contrats Adhérents: Confirmation enregistrement
      Système de Gestion Contrats Adhérents -> DB: Potentiellement mettre à jour statut mutualiste [ID Mutualiste]
      DB --> Système de Gestion Contrats Adhérents: Confirmation statut
      Système de Gestion Contrats Adhérents -> Service d'Audit: Enregistrer action association contrat (Qui, Quand, À Qui, Quel Contrat, Date Début)
      Service d'Audit --> Système de Gestion Contrats Adhérents: Confirmation audit

      Opt [Déclenchement calcul cotisations futures]
        Système de Gestion Contrats Adhérents -> Service de Calcul Cotisations: Déclencher recalcul cotisations futures [ID Mutualiste]
        Service de Calcul Cotisations --> Système de Gestion Contrats Adhérents: Statut déclenchement (Exc E3)

      Opt [Notification au mutualiste]
        Système de Gestion Contrats Adhérents -> Service de Notification: Envoyer notification association contrat [ID Mutualiste, Nom Contrat]
        Service de Notification --> Système de Gestion Contrats Adhérents: Statut envoi (Exc E3)

      Système de Gestion Contrats Adhérents --> UI Admin: Indiquer Succès Association
      UI Admin --> Administrateur: Afficher message succès

    Alt [Validation ou éligibilité KO, ou conflit contrat (Alt A2, A3, A4)]
      DB --> Système de Gestion Contrats Adhérents: Résultat vérifications
      Système de Configuration --> Système de Gestion Contrats Adhérents: Résultat vérif éligibilité
      Système de Gestion Contrats Adhérents --> UI Admin: Indiquer Échec Association avec raisons
      UI Admin --> Administrateur: Afficher message d'erreur

    Alt [Erreur Système lors enregistrement (Exc E2)]
      Système de Gestion Contrats Adhérents -> Système de Gestion Contrats Adhérents: Enregistrer log d'erreur technique
      Système de Gestion Contrats Adhérents --> UI Admin: Indiquer Échec Technique
      UI Admin --> Administrateur: Afficher message générique

  Alt [Mutualiste introuvable lors de la sélection (Exc E1)]
    DB --> Système de Gestion Contrats Adhérents: Indiquer mutualiste non trouvé
    Système de Gestion Contrats Adhérents --> UI Admin: Indiquer erreur (mutualiste introuvable)
    UI Admin --> Administrateur: Afficher message d'erreur

  Alt [Annulation par l'Administrateur (Alt A1)]
    Administrateur --> UI Admin: Cliquer "Annuler"
    UI Admin --> Administrateur: Rediriger (pas d'action backend)

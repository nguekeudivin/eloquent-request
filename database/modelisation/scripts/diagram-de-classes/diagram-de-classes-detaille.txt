@startuml
title Diagramme de Classes Détaillé (Relations & Clés)

' Stylisation
skinparam package {
  BorderColor Black
  FontColor Black
}
skinparam class {
  BorderColor Black
  BackgroundColor White
  ArrowColor Black
  AttributeFontStyle bold
}
skinparam linetype polyline

' === Packages ===

package "Gestion Utilisateurs & Accès" {
  class Utilisateur {
    {key} id
    --
    ' Other attributes omitted for focus
  }

  class Administrateur {
    {key} id {FK} ' Hérite de Utilisateur
    --
    ' Other attributes omitted
  }

  class "Super Administrateur" as SuperAdministrateur {
    {key} id {FK} ' Hérite de Administrateur
    --
    ' No specific keys needed here beyond inheritance
  }

  class Mutualiste {
    {key} id {FK} ' Hérite de Utilisateur
    --
    ' Other attributes omitted
  }

  class Role {
    {key} id
    --
    ' Other attributes omitted
  }

  class Permission {
    {key} id
    --
    ' Other attributes omitted
  }

  class AdministrateurRole {
    {key} administrateurId {FK}
    {key} roleId {FK}
    --
    ' Association attributes omitted
  }

  class RolePermission {
    {key} roleId {FK}
    {key} permissionId {FK}
    --
    ' Association attributes omitted
  }

  ' --- Relations ---
  Utilisateur <|-- Administrateur
  Utilisateur <|-- Mutualiste
  Administrateur <|-- SuperAdministrateur

  Administrateur "1" -- "*" AdministrateurRole
  Role "1" -- "*" AdministrateurRole
  (Administrateur, Role) .. AdministrateurRole

  Role "1" -- "*" RolePermission
  Permission "1" -- "*" RolePermission
  (Role, Permission) .. RolePermission
}

package "Gestion Adhérents & Contrats" {
  class Mutualiste {
    ' Defined in Utilisateurs package
  }

  class AyantDroit {
    {key} id
    mutualisteId {FK}
    --
    ' Other attributes omitted
  }

  class Contrat {
    {key} id
    --
    ' Other attributes omitted
  }

  class Adhesion {
    {key} id
    mutualisteId {FK}
    contratId {FK}
    --
    ' Other attributes omitted
  }

  ' --- Relations ---
  Mutualiste "1" *-- "0..*" AyantDroit
  Mutualiste "1" -- "0..*" Adhesion
  Contrat "1" -- "*" Adhesion
  Adhesion " * " -- "1" Mutualiste
}

package "Gestion Financière & Trésorerie" {
  class Cotisation {
    {key} id
    adhesionId {FK}
    --
    ' Other attributes omitted
  }

  class Paiement {
    {key} id
    mutualisteId {FK}
    --
    ' Other attributes omitted
  }

  class PaiementCotisation {
    {key} paiementId {FK}
    {key} cotisationId {FK}
    --
    ' Association attributes omitted
  }

  class Pret {
    {key} id
    mutualisteId {FK}
    accordeParAdminId {FK}
    --
    ' Other attributes omitted
  }

  class RachatPret {
    {key} id
    mutualisteId {FK}
    enregistreParAdminId {FK}
    --
    ' Other attributes omitted
  }

  class AidePonctuelle {
    {key} id
    mutualisteId {FK}
    verifieeParAdminId {FK}
    verseeParAdminId {FK}
    --
    ' Other attributes omitted
  }

  class DepenseFonctionnement {
    {key} id
    categorieDepenseId {FK}
    enregistreParAdminId {FK}
    --
    ' Other attributes omitted
  }

  class CategorieDepense {
    {key} id
    --
    ' Other attributes omitted
  }

  class Caisse {
    {key} id
    --
    ' Other attributes omitted
  }

  class MouvementCaisse {
    {key} id
    caisseId {FK}
    enregistreParAdminId {FK}
    depenseFonctionnementId {FK} {Nullable}
    paiementId {FK} {Nullable}
    --
    ' Other attributes omitted
  }

  ' --- Relations ---
  Adhesion "1" -- "0..*" Cotisation
  Mutualiste "1" -- "0..*" Paiement
  Paiement "1" -- "*" PaiementCotisation
  Cotisation "1" -- "*" PaiementCotisation
  (Paiement, Cotisation) .. PaiementCotisation

  Mutualiste "1" -- "0..*" Pret
  Administrateur "1" -- "0..*" Pret

  Mutualiste "1" -- "0..*" RachatPret
  Administrateur "1" -- "0..*" RachatPret

  Mutualiste "1" -- "0..*" AidePonctuelle
  Administrateur "1" -- "0..*" AidePonctuelle

  CategorieDepense "1" -- "0..*" DepenseFonctionnement
  Administrateur "1" -- "0..*" DepenseFonctionnement

  Caisse "1" -- "0..*" MouvementCaisse
  Administrateur "1" -- "0..*" MouvementCaisse
  DepenseFonctionnement "0..1" -- "*" MouvementCaisse
  Paiement "0..1" -- "*" MouvementCaisse

  ' Explicit link for cash payments via MouvementCaisse
  Paiement "1" -- "0..1" MouvementCaisse
}

package "Gestion Services & Prestations" {
  class Prestation {
    {key} id
    --
    ' Other attributes omitted
  }

  class PriseEnCharge {
    {key} id
    mutualisteId {FK}
    ayantDroitId {FK} {Nullable}
    prestationId {FK}
    adhesionId {FK}
    soumiseParUtilisateurId {FK}
    valideeParAdminId {FK} {Nullable}
    --
    ' Other attributes omitted
  }

  class Liquidation {
    {key} id
    priseEnChargeId {FK}
    payeParAdminId {FK}
    --
    ' Other attributes omitted
  }

  ' --- Relations ---
  Contrat "1" -- "0..*" Prestation

  Prestation "1" -- "*" PriseEnCharge
  Mutualiste "1" -- "0..*" PriseEnCharge
  AyantDroit "0..1" -- "*" PriseEnCharge
  Adhesion "1" -- "0..*" PriseEnCharge
  Utilisateur "1" -- "0..*" PriseEnCharge
  Administrateur "0..1" -- "*" PriseEnCharge

  PriseEnCharge "1" -- "0..1" Liquidation
  Administrateur "1" -- "0..*" Liquidation
}

package "Gestion Matériels" {
  class Materiel {
    {key} id
    --
    ' Other attributes omitted
  }

  class PretMateriel {
    {key} id
    materielId {FK}
    mutualisteId {FK}
    enregistreParAdminId {FK}
    retourEnregistreParAdminId {FK} {Nullable}
    --
    ' Other attributes omitted
  }

  ' --- Relations ---
  Materiel "1" -- "0..*" PretMateriel
  Mutualiste "1" -- "0..*" PretMateriel
  Administrateur "1" -- "0..*" PretMateriel
  Administrateur "0..1" -- "*" PretMateriel
}

package "Gestion Communication & Suivi" {
  class Reclamation {
    {key} id
    mutualisteId {FK}
    soumiseParUtilisateurId {FK}
    assigneeAAdminId {FK} {Nullable}
    --
    ' Other attributes omitted
  }

  class Conversation {
    {key} id
    --
    ' Other attributes omitted
  }

  class Message {
    {key} id
    conversationId {FK}
    utilisateurId {FK}
    --
    ' Other attributes omitted
  }

  class ConversationParticipant {
    {key} conversationId {FK}
    {key} utilisateurId {FK}
    --
    ' Association attributes omitted
  }

  class Notification {
    {key} id
    utilisateurId {FK}
    --
    ' Other attributes omitted
  }

  ' --- Relations ---
  Mutualiste "1" -- "0..*" Reclamation
  Utilisateur "1" -- "0..*" Reclamation
  Administrateur "0..1" -- "*" Reclamation

  Conversation "1" -- "0..*" Message
  Message " * " -- "1" Conversation
  Utilisateur "1" -- "0..*" Message

  Conversation "1" -- "*" ConversationParticipant
  Utilisateur "1" -- "*" ConversationParticipant
  (Conversation, Utilisateur) .. ConversationParticipant

  Utilisateur "1" -- "0..*" Notification
}

package "Système & Maintenance" {
    class LogActivite {
      {key} id
      utilisateurId {FK} {Nullable}
      --
      ' Other attributes omitted
    }

    class Rapport {
      {key} id
      --
      ' Other attributes omitted
    }

    class SauvegardeDB {
      {key} id
      utilisateurId {FK} {Nullable}
      --
      ' Other attributes omitted
    }

    class RestaurationDB {
      {key} id
      utilisateurId {FK}
      --
      ' Other attributes omitted
    }

    ' --- Relations ---
    Utilisateur "0..1" -- "*" LogActivite
    Utilisateur "0..1" -- "*" SauvegardeDB
    Utilisateur "1" -- "0..*" RestaurationDB
}

@enduml
title UC 32 - Lancer la procédure de liquidation des droits

Acteurs: Administrateur
Lifelines:
  Administrateur
  Interface Administration (UI Admin)
  Système de Gestion Liquidations (Backend/Système)
  Base de Données (DB)
  Service de Calcul Droits (Backend/Système)
  Service d'Audit (Audit Service)
  Service de Notification (Optionnel)

Flux:
  Administrateur -> UI Admin: Accéder section gestion liquidations / dossier mutualiste
  Administrateur -> UI Admin: Identifier et sélectionner mutualiste/bénéficiaires pour liquidation [IDs]
  Administrateur -> UI Admin: Choisir option "Lancer procédure de liquidation"

  UI Admin --> Administrateur: Afficher boîte confirmation/saisie événement déclencheur
  Administrateur -> UI Admin: Confirmer et spécifier événement déclencheur

  UI Admin -> Système de Gestion Liquidations: Envoyer requête lancement procédure [IDs Bénéficiaires, Événement Déclencheur]

  Système de Gestion Liquidations -> DB: Vérifier préconditions (Éligibilité, Données disponibles) [IDs Bénéficiaires]
  DB --> Système de Gestion Liquidations: Résultat vérification préconditions

  Alt [Préconditions remplies]
    Système de Gestion Liquidations -> DB: Créer nouvel enregistrement procédure liquidation [IDs, Événement]
    DB --> Système de Gestion Liquidations: Confirmation création procédure
    Système de Gestion Liquidations -> DB: Définir statut initial procédure ("Initiée") [ID Procédure]
    DB --> Système de Gestion Liquidations: Confirmation statut
    Système de Gestion Liquidations -> Service d'Audit: Enregistrer action lancement liquidation (Qui, Quand, Pour Qui, Événement)
    Service d'Audit --> Système de Gestion Liquidations: Confirmation audit

    Système de Gestion Liquidations -> Service de Calcul Droits: Déclencher calcul des droits acquis [ID Procédure, IDs Bénéficiaires, Événement]
    Service de Calcul Droits --> Système de Gestion Liquidations: Statut déclenchement (asynchrone/synchrone)

    Système de Gestion Liquidations --> UI Admin: Indiquer Succès Lancement Procédure
    UI Admin --> Administrateur: Afficher message succès ("Procédure lancée...")

    Opt [Notification aux bénéficiaires/mutualiste (Exc E3)]
      Système de Gestion Liquidations -> Service de Notification: Envoyer notification lancement procédure [IDs, Événement]

  Alt [Préconditions non remplies (Alt A2, A3)]
    Système de Gestion Liquidations --> UI Admin: Indiquer Échec Lancement avec raison (Non éligible, Données manquantes)
    UI Admin --> Administrateur: Afficher message d'erreur

  Alt [Mutualiste/Bénéficiaire introuvable (Exc E1)]
    DB --> Système de Gestion Liquidations: Indiquer introuvable
    Système de Gestion Liquidations --> UI Admin: Indiquer erreur (introuvable)
    UI Admin --> Administrateur: Afficher message d'erreur

  Alt [Erreur Système lors création/déclenchement (Exc E2)]
    Système de Gestion Liquidations -> Système de Gestion Liquidations: Enregistrer log d'erreur technique
    Système de Gestion Liquidations --> UI Admin: Indiquer Échec Technique
    UI Admin --> Administrateur: Afficher message d'erreur générique

  Alt [Annulation par l'Administrateur (Alt A1)]
    Administrateur --> UI Admin: Cliquer "Annuler"
    UI Admin --> Administrateur: Fermer boîte / Rediriger